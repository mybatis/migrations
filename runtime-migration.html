<!DOCTYPE html>


<!--
 | Generated by Apache Maven Doxia Site Renderer 2.0.0-M19 from src/site/xdoc/runtime-migration.xml at 10 Aug 2024
 | Rendered using Apache Maven Fluido Skin 2.0.0-M9
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 2.0.0-M19" />
    <meta name="author" content="The MyBatis Team" />
    <title>MyBatis Migrations | Runtime Schema Upgrade – MyBatis Migrations</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-2.0.0-M9.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
    <script src="./js/apache-maven-fluido-2.0.0-M9.min.js"></script>
  </head>
  <body>
    <div class="container-fluid container-fluid-top">
      <header>
        <div id="banner">
          <div class="pull-left"></div>
          <div class="pull-right"><div id="bannerRight"><h1><a href="https://blog.mybatis.org/" class="externalLink"><img class="imageLink" src="../images/mybatis-logo.png" alt="MyBatis logo" /> MyBatis</a></h1></div></div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
        <li id="publishDate">Last Published: 10 Aug 2024<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 3.4.0</li>
          </ul>
        </div>
      </header>
      <div class="row-fluid">
        <header id="leftColumn" class="span2">
          <nav class="well sidebar-nav">
  <ul class="nav nav-list">
   <li class="nav-header">Migrations</li>
    <li><a href="index.html">Introduction</a></li>
    <li><a href="installation.html">Installation</a></li>
    <li><a href="migrate.html"><span class="icon-chevron-down"></span>The &apos;migrate&apos; Command</a>
     <ul class="nav nav-list">
      <li><a href="init.html">init</a></li>
      <li><a href="bootstrap.html">bootstrap</a></li>
      <li><a href="new.html">new</a></li>
      <li><a href="status.html">status</a></li>
      <li><a href="updown.html">up, down</a></li>
      <li><a href="version.html">version</a></li>
      <li><a href="pending.html">pending</a></li>
      <li><a href="redo.html">redo</a></li>
      <li><a href="script.html">script</a></li>
      <li><a href="shortcuts.html">Command Shortcuts</a></li>
      <li><a href="custom-loader.html">Custom MigrationLoader</a></li>
     </ul></li>
    <li><a href="hooks.html">Migration Hooks</a></li>
    <li class="active"><a>Runtime Schema Migration</a></li>
   <li class="nav-header">Project Documentation</li>
    <li><a href="project-info.html"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="project-reports.html"><span class="icon-chevron-right"></span>Project Reports</a></li>
  </ul>
          </nav>
          <div class="well sidebar-nav">
            <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
<a href="https://maven.apache.org/" class="builtBy" target="_blank"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </header>
        <main id="bodyColumn" class="span10">


  

    <section><a id="Runtime_Schema_Upgrade"></a>
<h1>Runtime Schema Upgrade</h1>

      
<p>
        Since 3.2.0, MyBatis Migrations supports runtime schema upgrade (a.k.a. in-app migration).
      </p>

      
<p>
        If you distributed your application in binary form (e.g. WAR or JAR) and want to make some changes to the database schema after the initial release, that's where the Runtime Schema Upgrade helps.
      </p>

      <section><a id="Overview"></a>
<h2>Overview</h2>

        
<p>
          To use Runtime Schema Upgrade, you need to create Migration Scripts.<br />
          Migration scripts can be written as text files (.sql) or java classes that implements <code>MigrationScript</code> interface.
        </p>

        
<p>
          Then during the startup process of your application, perform 'Up' operation by executing <code>UpOperation#operate()</code> method.<br />
          Assuming that your java migration scripts are in 'mycompany.migration.script' package and you can obtain <code>java.sql.DataSource</code> instance, the below is the minimum code to perform 'Up' operation.
        </p>

        
<pre class="prettyprint"><code>new UpOperation().operate(
  new DataSourceConnectionProvider(dataSource),
    new JavaMigrationLoader(&quot;mycompany.migration.script&quot;), null, null);</code></pre>

        
<p>
          As the first migration script should be the one that creates the 'changelog' table, the initial release of your application may contain two or more migration scripts.<br />
          To upgrade the schema in the next version, just add new migration scripts to the package.
        </p>

      </section>

      <section><a id="Migration_Script"></a>
<h2>Migration Script</h2>

        
<p>
          By default, MyBatis Migration supports two types of Migration Script: simple SQL script file (*.sql) and java migration script.
        </p>

        
<p>
          You have already learned about the simple SQL script file (*.sql) that can be generated by the <code>migrate new</code> command in the former sections.
          As it is just a text file, it is easy to write or edit, but a little bit harder to use with Runtime Schema Upgrade because it needs to be accessible in the file system (i.e. JAR or WAR must be extracted on the runtime environment).
        </p>

        
<p>
          A java migration script is a java class that implements <code>MigrationScript</code> interface (see below).
          It must be compiled, of course, but it can be placed anywhere in the classpath, so it may be a better choice for Runtime Schema Upgrade in most cases.
        </p>

        
<pre class="prettyprint"><code>
public interface MigrationScript {
  BigDecimal getId();
  String getDescription();
  String getUpScript();
  String getDownScript();
}</code></pre>

        
<p>
          <code>getId()</code> method should return a unique ID of the migration script. Newer script must return a larger number.<br />
          <code>getDescription()</code> method should return a short description of the script.<br />
          <code>getUpScript()</code> method should return the actual SQL statements upgrading the schema.<br />
          <code>getDownScript()</code> method should return SQL statements downgrading the schema, but it exists mainly for API consistency and would not be used in Runtime Schema Upgrade.
        </p>

        
<p>
          Here is a typical implementation of the first migration script that creates the 'changelog' table:
        </p>

        
<pre class="prettyprint"><code>
package mycompany.migration.script

import java.math.BigDecimal;
import org.apache.ibatis.migration.MigrationScript;

public class V001_CreateChangelog implements MigrationScript {
  public BigDecimal getId() {
    return BigDecimal.valueOf(1L);
  }

  public String getDescription() {
    return &quot;Create changelog&quot;;
  }

  public String getUpScript() {
    return &quot;CREATE TABLE changelog (&quot;
      + &quot;ID NUMERIC(20,0) NOT NULL,&quot;
      + &quot;APPLIED_AT VARCHAR(25) NOT NULL,&quot;
      + &quot;DESCRIPTION VARCHAR(255) NOT NULL); &quot;

      + &quot;ALTER TABLE changelog &quot;
      + &quot;ADD CONSTRAINT PK_changelog &quot;
      + &quot;PRIMARY KEY (id);&quot;;
  }

  public String getDownScript() {
    return &quot;DROP TABLE changelog;&quot;;
  }
}</code></pre>

      </section>

      <section><a id="UpOperation.23operate.28.29"></a>
<h2>UpOperation#operate()</h2>

        
<p>
          As shown in the Overview section, Runtime Schema Upgrade is executed by calling the <code>operate()</code> method of an <code>UpOperation</code> instance.<br />
          The method takes four parameters.
        </p>

        
<ul>
          
<li><code>ConnectionProvider</code>: Required. Explained in the later section.</li>
          
<li><code>MigrationLoader</code>: Required. Explained in the later section.</li>
          
<li><code>DatabaseOperationOption</code>: Optional. If <code>null</code> is passed, the default values are used.</li>
          
<li><code>PrintStream</code>: Optional. The result of the Up operation will be output to this stream.</li>
        </ul>

      </section>

      <section><a id="ConnectionProvider"></a>
<h2>ConnectionProvider</h2>

        
<p>
          <code>ConnectionProvider</code> interface has only one method <code>getConnection()</code> which returns <code>java.sql.Connection</code> used by 'Up' operation.
        </p>

        
<pre class="prettyprint"><code>
public interface ConnectionProvider {
  Connection getConnection() throws SQLException;
}</code></pre>

        
<p>
          There are two built-in implementations: <code>DataSourceConnectionProvider</code> and <code>JdbcConnectionProvider</code>.
        </p>

        
<p>
          You have already seen the example usage of <code>DataSourceConnectionProvider</code> in the Overview section.
          The constructor takes an instance of <code>java.sql.DataSource</code> as its only argument.
        </p>

        
<p>
          <code>JdbcConnectionProvider</code> takes four constructor arguments: JDBC driver class, JDBC URL, username and password.<br />
          Using <code>JdbcConnectionProvider</code>, the example code in the Overview section can be rewritten as follows.
        </p>

        
<pre class="prettyprint"><code>new UpOperation().operate(
  new JdbcConnectionProvider(&quot;org.hsqldb.jdbcDriver&quot;, &quot;jdbc:hsqldb:mem:mydb&quot;, &quot;myname&quot;, &quot;mypassword&quot;),
    new JavaMigrationLoader(&quot;mycompany.migration.script&quot;), null, null);</code></pre>

      </section>

      <section><a id="MigrationLoader"></a>
<h2>MigrationLoader</h2>

        
<p>
          <code>MigrationLoader</code> abstracts where and how to load your migration scripts.<br />
          There are two built-in implementations: <code>FileMigrationLoader</code> and <code>JavaMigrationLoader</code>.
        </p>

        
<p>
          <code>FileMigrationLoader</code> is used to load simple SQL scripts (*.sql).<br />
          Its constructor takes three arguments:
        </p>

        
<pre class="prettyprint"><code>FileMigrationLoader(File scriptsDir, String charset, Properties properties)</code></pre>

        
<ul>
          
<li><code>scriptsDir</code> is the only required parameter and it indicates the directory containing the migration scripts. Note that the directory must exist in the file system of the runtime environment.</li>
          
<li><code>charset</code> is the character set of the migration scripts.
          If <code>null</code> is passed, system's default charset is used.</li>
          
<li><code>properties</code> is used for variable substitution when reading the migration scripts (e.g. ${changelog}).</li>
        </ul>

        
<p>
          <code>JavaMigrationLoader</code> loads java classes which implement <code>MigrationScript</code> interface.<br />
          There are two constructors defined for <code>JavaMigrationLoader</code>
        </p>

        
<pre class="prettyprint"><code>JavaMigrationLoader(String... packageNames)

JavaMigrationLoader(ClassLoader classLoader, String... packageNames)</code></pre>

        
<ul>
          
<li><code>packageNames</code> is the list of packages that contains migration scripts.
          Note that the migration scripts are ordered by their IDs.</li>
          
<li><code>classLoader</code> is used to search the migration scripts and is optional.</li>
        </ul>

      </section>

    </section>

  


        </main>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>©      2010–2024
<a href="https://www.mybatis.org/">MyBatis.org</a>
</p>
        </div>
      </div>
    </footer>
<script>
  if(anchors) {
    anchors.add();
  }
</script>
  </body>
</html>