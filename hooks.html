<!DOCTYPE html>


<!--
 | Generated by Apache Maven Doxia Site Renderer 2.0.0 from src/site/xdoc/hooks.xml at 26 May 2025
 | Rendered using Apache Maven Fluido Skin 2.1.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 2.0.0" />
    <meta name="author" content="The MyBatis Team" />
    <title>MyBatis Migrations | Migration hooks â€“ MyBatis Migrations</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-2.1.0.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
    <script src="./js/apache-maven-fluido-2.1.0.min.js"></script>
  </head>
  <body>
    <div class="container-fluid container-fluid-top">
      <header>
        <div id="banner">
          <div class="pull-left"></div>
          <div class="pull-right"><div id="bannerRight"><h1><a href="https://blog.mybatis.org/"><img src="../images/mybatis-logo.png" alt="MyBatis logo" /> MyBatis</a></h1></div></div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
        <li id="publishDate">Last Published: 10 Aug 2024<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 3.4.1-SNAPSHOT</li>
          </ul>
        </div>
      </header>
      <div class="row-fluid">
        <header id="leftColumn" class="span2">
          <nav class="well sidebar-nav">
  <ul class="nav nav-list">
   <li class="nav-header">Migrations</li>
    <li><a href="index.html">Introduction</a></li>
    <li><a href="installation.html">Installation</a></li>
    <li><a href="migrate.html"><span class="icon-chevron-down"></span>The &apos;migrate&apos; Command</a>
     <ul class="nav nav-list">
      <li><a href="init.html">init</a></li>
      <li><a href="bootstrap.html">bootstrap</a></li>
      <li><a href="new.html">new</a></li>
      <li><a href="status.html">status</a></li>
      <li><a href="updown.html">up, down</a></li>
      <li><a href="version.html">version</a></li>
      <li><a href="pending.html">pending</a></li>
      <li><a href="redo.html">redo</a></li>
      <li><a href="script.html">script</a></li>
      <li><a href="shortcuts.html">Command Shortcuts</a></li>
      <li><a href="custom-loader.html">Custom MigrationLoader</a></li>
     </ul></li>
    <li class="active"><a>Migration Hooks</a></li>
    <li><a href="runtime-migration.html">Runtime Schema Migration</a></li>
   <li class="nav-header">Project Documentation</li>
    <li><a href="project-info.html"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="project-reports.html"><span class="icon-chevron-right"></span>Project Reports</a></li>
  </ul>
          </nav>
          <div class="well sidebar-nav">
            <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
<a href="https://maven.apache.org/" class="builtBy" target="_blank"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </header>
        <main id="bodyColumn" class="span10">


  

    <section><a id="Migration_Hooks"></a>
<h1>Migration Hooks</h1>

      
<p>
        Since 3.3.0, MyBatis Migrations supports pre/post-migration hooks.
      </p>

      <section><a id="Overview"></a>
<h2>Overview</h2>

        
<p>
          You can write scripts that are executed before or after up/down operation.<br />
          Hook scripts can be written in <b>SQL</b> or <b>JSR-223</b> compliannt script languages.
        </p>

      </section>

      <section><a id="Quick_start"></a>
<h2>Quick start</h2>

        
<p>
          Here is what you need to do to use hook scripts.
        </p>

        
<ol style="list-style-type: decimal;">
          
<li>Create <i>hooks</i> directory.</li>
          
<li>Create a hook script in <i>hooks</i> directory.</li>
          
<li>Add a setting to the environment properties file.</li>
        </ol>

        <section><section><a id="a1._Create_hooks_directory."></a>
<h4>1. Create <i>hooks</i> directory.</h4>

        
<p>
          Create a directory named <i>hooks</i> in the base directory.
        </p>

        </section><section><a id="a2._Create_a_hook_script_in_hooks_directory."></a>
<h4>2. Create a hook script in <i>hooks</i> directory.</h4>

        
<p>
          The following script outputs the famous string to the log.<br />
          Save this script in the <i>hooks</i> directory as <i>hello.js</i>.
        </p>

        
<pre class="prettyprint"><code>print('Hello, World!');</code></pre>

        </section><section><a id="a3._Add_a_setting_to_the_environment_properties_file."></a>
<h4>3. Add a setting to the environment properties file.</h4>

        
<p>
          To configure Migrations, add the following line to the <i>development.properties</i> in the <i>environments</i> directory.
        </p>

        
<pre class="prettyprint"><code>hook_before_up=JavaScript:hello.js</code></pre>

        
<p>
          The details will be explained in the later section, but the above line tells Migrations to execute <i>hello.js</i> at the beginning of <code>migrate up</code> operation.
        </p>

        
<p>
          Now, if you run <code>migrate up</code>, you will find the following lines in the log.
        </p>

        
<pre class="prettyprint"><code>========== Applying JSR-223 hook : hello.js ==========
Hello, World!</code></pre>

        
<p>
          <span class="label important">NOTE</span>
          The hook script will not be executed if there was no pending migration.
        </p>

      </section></section></section>

      <section><a id="Configuration"></a>
<h2>Configuration</h2>

        
<p>
          As shown in the Quick Start section, migration hook is configured by adding a line in the environment properties file in <code>key=value</code> format.<br />
        </p>

        <section><section><a id="Keys_for_available_hooks"></a>
<h4>Keys for available hooks</h4>

        
<p>
          Here is the list of available hooks.
        </p>

        
<ul>
          
<li>hook_before_up</li>
          
<li>hook_before_each_up</li>
          
<li>hook_after_each_up</li>
          
<li>hook_after_up</li>
          
<li>hook_before_down</li>
          
<li>hook_before_each_down</li>
          
<li>hook_after_each_down</li>
          
<li>hook_after_down</li>
          
<li>hook_before_new [1] (since 3.3.5)</li>
          
<li>hook_after_new [1] (since 3.3.5)</li>
          
<li>hook_before_script [1] (since 3.3.10)</li>
          
<li>hook_before_each_script [1] (since 3.3.10)</li>
          
<li>hook_after_each_script [1] (since 3.3.10)</li>
          
<li>hook_after_script [1] (since 3.3.10)</li>
        </ul>

        
<p>[1] Only JSR-223 script is supported.</p>

        </section><section><a id="Minimum_setting_.3A_language_and_file_name"></a>
<h4>Minimum setting : language and file name</h4>

        
<p>
          The value part of the setting line consists of two or more segments separated with a colon <code>:</code>.<br />
          The first segment is the language name (e.g. <code>SQL</code>, <code>JavaScript</code>, <code>Groovy</code>, etc.). The second segment is the file name. These two segments are required.
          Here are some examples:
        </p>

        
<pre class="prettyprint"><code>hook_before_up=SQL:insert_log.sql
hook_after_up=JavaScript:RestartServer.js</code></pre>

      </section></section></section>

      <section><a id="Constant_variables"></a>
<h2>Constant variables</h2>

        
<p>
          The other segments are used to define constant variables specific to this particular hook script. These variables can have arbitrary names, but there also are some special variable names for JSR-223 hooks that are explained in the later section.
        </p>

        
<p>
          The following settings reference the same hook script <i>printvar.js</i> with different variable values.
        </p>

        
<pre class="prettyprint"><code>// development.properties
hook_before_up=JavaScript:printvar.js:when=before:what=up
hook_after_down=JavaScript:printvar.js:when=after:what=down</code></pre>

        
<p>
          Constant variables can be referenced as global variables in JavaScript.
        </p>

        
<pre class="prettyprint"><code>// printvar.js
print('This is ' + when + ' ' + what + ' hook.');</code></pre>

        
<p>
          The above script will print <code>This is before up hook.</code> on <code>migrate up</code> and <code>This is after down hook.</code> on <code>migrate down</code>.
        </p>

        
<p>
          Also, if there are global variables defined in the environment properties file, they can be used in hook scripts in the same manner.
        </p>

        
<pre class="prettyprint"><code>// development.properties
foo=bar</code></pre>

        
<p>
          These variables can be used in SQL hook scripts as well.
        </p>

        
<pre class="prettyprint"><code># development.properties
hook_before_up=SQL:update_timestamp.sql:col=before
hook_after_up=SQL:update_timestamp.sql:col=after</code></pre>
        
<pre class="prettyprint"><code>// update_timestamp.sql
update worklog set ${col} = current_date();</code></pre>

      </section>

      <section><a id="Advanced_usage_of_JSR-223_scripts"></a>
<h2>Advanced usage of JSR-223 scripts</h2>

        <section><section><a id="Get_paths_to_the_directories"></a>
<h4>Get paths to the directories</h4>

        
<p>
          An instance of <a href="/migrations/apidocs/org/apache/ibatis/migration/options/SelectedPaths.html" target="_blank">SelectedPaths</a> object is accessible as a global variable <code>migrationPaths</code>.
        </p>

        
<pre class="prettyprint"><code>print(migrationPaths.getBasePath());
print(migrationPaths.getEnvPath());
print(migrationPaths.getScriptPath());
print(migrationPaths.getDriverPath());
print(migrationPaths.getHookPath());</code></pre>

        </section><section><a id="About_hookContext"></a>
<h4>About <i>hookContext</i></h4>

        
<p>
          A global variable <code>hookContext</code> is passed to each hook script, but the object bound to this variable depends on the hook.
        </p>

        
<ul>
          
<li>For <code>up</code> and <code>down</code> hooks, <code>hookConte</code> is an instance of <a href="/migrations/apidocs/org/apache/ibatis/migration/hook/HookContext.html" target="_blank">HookContext</a>.</li>
          
<li>For <code>new</code> hooks, <code>hookContext</code> is an instance of <a href="/migrations/apidocs/org/apache/ibatis/migration/hook/NewHookContext.html" target="_blank">NewHookContext</a>.</li>
          
<li>For <code>script</code> hooks, <code>hookContext</code> is an instance of <a href="/migrations/apidocs/org/apache/ibatis/migration/hook/ScriptHookContext.html" target="_blank">ScriptHookContext</a>.</li>
        </ul>

        </section><section><a id="Accessing_Change_object_.28in_each_hook_only.29"></a>
<h4>Accessing <i>Change</i> object (in each hook only)</h4>

        
<p>
          In an each hook script, an instance of <a href="/migrations/apidocs/org/apache/ibatis/migration/Change.html" target="_blank">Change</a> object is accessible via the global variable <code>hookContext</code>.
        </p>

        
<pre class="prettyprint"><code>print(hookContext.getChange().getId());
print(hookContext.getChange().getFilename());</code></pre>

        
<p>
          <span class="label important">NOTE</span>
          The Change instance is a clone and will be discarded after each exection, so modifying it would be meaningless.
        </p>

        
<p>
          <span class="label important">NOTE</span>
          Change is not available to before_new and after_new hooks.
        </p>

        </section><section><a id="Execute_SQL_statement"></a>
<h4>Execute SQL statement</h4>

        
<p>
          You can execute arbitrary SQL statement via the built-in global object <code>hookContext</code>.
        </p>

        
<pre class="prettyprint"><code>hookContext.executeSql(&quot;insert into worklog (str1) values ('done!');&quot;);</code></pre>

        
<p>
          If you need more than just executing SQL statement, you can get an instance of <code>java.sql.Connection</code> from <code>hookContext</code>.
        </p>

        
<pre class="prettyprint"><code>con = hookContext.getConnection();
try {
  stmt = con.createStatement();
  rs = stmt.executeQuery(&quot;select * from changelog&quot;);
  while (rs.next()) {
    print(&quot;id = &quot; + rs.getString(&quot;id&quot;));
  }
} finally {
  con.close();
  con = null;
  rs = null;
  stmt = null;
}</code></pre>

        
<p>
          <span class="label important">NOTE</span>
          These methods are not available to before_new and after_new hooks.
        </p>

        </section><section><a id="Invoking_function"></a>
<h4>Invoking function</h4>

        
<p>
          When configuring JSR-223 hook scripts, it is possible to specify a top level function to invoke. The following script contains two functions <code>foo</code> and <code>bar</code> and <code>bar</code> takes two arguments.
        </p>

        
<pre class="prettyprint"><code>// foobar.js
function foo() {
  print('foo');
}

function bar(id, name) {
  print(id + ':' + name);
}</code></pre>

        
<p>
          To invoke these function, specify the function name using a special variable name <code>_function</code> and parameter values with <code>_arg</code>.
        </p>

        
<pre class="prettyprint"><code>hook_before_up=js:foobar.js:_function=foo
hook_after_up=js:foobar.js:_function=bar:_arg=100:_arg=John</code></pre>

        
<p>
          <span class="label important">NOTE</span>
          Some JSR-223 implementation may not support function invocation.
        </p>

        </section><section><a id="Invoking_method"></a>
<h4>Invoking method</h4>

        
<p>
          Similar to function invocation, it is also possible to invoke a method of an top level object.
        </p>

        
<pre class="prettyprint"><code>// doggy.js
var dog = new Object();
dog.bark = function(who, times) {
  print('bow-wow ' + times + ' times at ' + who);
});</code></pre>

        
<p>
          In the hook setting, use <code>_object</code> to specify the object name and <code>_method</code> to specify the method name.
        </p>

        
<pre class="prettyprint"><code>hook_before_up=js:doggy.js:_object=dog:_method=bark:_arg=Lucy:_arg=128</code></pre>

        
<p>
          <span class="label important">NOTE</span>
          Some JSR-223 implementation may not support method invocation.
        </p>

        </section><section><a id="Retain_variable_value_throughout_the_operation"></a>
<h4>Retain variable value throughout the operation</h4>

        
<p>
          When single up/down operation executes multiple migrations, variables are reset on each migration.<br />
          There are two ways to retain variable value throughout the operation.
        </p>

        
<ol style="list-style-type: decimal;">
          
<li>
            Initialize the variable in before_up/down script and use it in before/after_each_up/down script.
            
<pre class="prettyprint"><code>// before_up hook script
var counter = 1;</code></pre>
            
<pre class="prettyprint"><code>// before_each_up hook script
print(counter++);</code></pre>
          </li>
          
<li>
            Initialize only when the variable is <i>undefined</i>.
            
<pre class="prettyprint"><code>if (typeof counter == 'undefined') this.counter = 1;
println(counter++);</code></pre>
          </li>
        </ol>

        </section><section><a id="Use_other_languages_than_JavaScript"></a>
<h4>Use other languages than JavaScript</h4>

        
<p>
          To use other JSR-223 compliant scripting language than JavaScript, you need to copy required .jar files to <i>$MIGRATIONS_HOME/lib</i> directory.
        </p>

        
<p>
          To write hook scripts in <a href="http://groovy-lang.org" target="_blank" class="externalLink">Groovy</a>, for example, you will need <a href="http://mvnrepository.com/artifact/org.codehaus.groovy/groovy" target="_blank" class="externalLink">groovy.jar</a> and <a href="http://mvnrepository.com/artifact/org.codehaus.groovy/groovy-jsr223" target="_blank" class="externalLink">groovy-jsr223.jar</a>.<br />
          Once the JARs are placed in <i>$MIGRATIONS_HOME/lib</i> directory, the rest is pretty much the same as JavaScript.<br />
          Save the following script as <code>hello.groovy</code> in <i>hooks</i> directory with the following content...
        </p>

        
<pre class="prettyprint"><code>println('Hello groovy!')</code></pre>

        
<p>...and add the setting to the environment properties file.</p>

        
<pre class="prettyprint"><code>hook_before_up=groovy:hello.groovy</code></pre>

      </section></section></section>

    </section>

  

        </main>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Â©      2010â€“2025
<a href="https://www.mybatis.org/">MyBatis.org</a>
</p>
        </div>
      </div>
    </footer>
  </body>
</html>
