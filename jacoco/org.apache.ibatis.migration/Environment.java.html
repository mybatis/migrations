<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Environment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MyBatis Migrations</a> &gt; <a href="index.source.html" class="el_package">org.apache.ibatis.migration</a> &gt; <span class="el_source">Environment.java</span></div><h1>Environment.java</h1><pre class="source lang-java linenums">/*
 *    Copyright 2010-2023 the original author or authors.
 *
 *    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 *    you may not use this file except in compliance with the License.
 *    You may obtain a copy of the License at
 *
 *       https://www.apache.org/licenses/LICENSE-2.0
 *
 *    Unless required by applicable law or agreed to in writing, software
 *    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *    See the License for the specific language governing permissions and
 *    limitations under the License.
 */
package org.apache.ibatis.migration;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.nio.charset.Charset;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Properties;

public class Environment {

  public static final String CHANGELOG = &quot;changelog&quot;;

<span class="fc" id="L35">  private enum SETTING_KEY {</span>
<span class="fc" id="L36">    TIME_ZONE,</span>

<span class="fc" id="L38">    DELIMITER,</span>

<span class="fc" id="L40">    SCRIPT_CHAR_SET,</span>

<span class="fc" id="L42">    FULL_LINE_DELIMITER,</span>

<span class="fc" id="L44">    SEND_FULL_SCRIPT,</span>

<span class="fc" id="L46">    AUTO_COMMIT,</span>

<span class="fc" id="L48">    REMOVE_CRS,</span>

<span class="fc" id="L50">    IGNORE_WARNINGS,</span>

<span class="fc" id="L52">    DRIVER_PATH,</span>

<span class="fc" id="L54">    DRIVER,</span>

<span class="fc" id="L56">    URL,</span>

<span class="fc" id="L58">    USERNAME,</span>

<span class="fc" id="L60">    PASSWORD,</span>

<span class="fc" id="L62">    HOOK_BEFORE_UP,</span>

<span class="fc" id="L64">    HOOK_BEFORE_EACH_UP,</span>

<span class="fc" id="L66">    HOOK_AFTER_EACH_UP,</span>

<span class="fc" id="L68">    HOOK_AFTER_UP,</span>

<span class="fc" id="L70">    HOOK_BEFORE_DOWN,</span>

<span class="fc" id="L72">    HOOK_BEFORE_EACH_DOWN,</span>

<span class="fc" id="L74">    HOOK_AFTER_EACH_DOWN,</span>

<span class="fc" id="L76">    HOOK_AFTER_DOWN,</span>

<span class="fc" id="L78">    HOOK_BEFORE_NEW,</span>

<span class="fc" id="L80">    HOOK_AFTER_NEW,</span>

<span class="fc" id="L82">    HOOK_BEFORE_SCRIPT,</span>

<span class="fc" id="L84">    HOOK_BEFORE_EACH_SCRIPT,</span>

<span class="fc" id="L86">    HOOK_AFTER_EACH_SCRIPT,</span>

<span class="fc" id="L88">    HOOK_AFTER_SCRIPT;</span>

    @Override
    public String toString() {
<span class="fc" id="L92">      return this.name().toLowerCase(Locale.ENGLISH);</span>
    }
  }

  private static final List&lt;String&gt; SETTING_KEYS;

  static {
<span class="fc" id="L99">    ArrayList&lt;String&gt; list = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L100">    SETTING_KEY[] keys = SETTING_KEY.values();</span>
<span class="fc bfc" id="L101" title="All 2 branches covered.">    for (SETTING_KEY key : keys) {</span>
<span class="fc" id="L102">      list.add(key.toString());</span>
    }
<span class="fc" id="L104">    SETTING_KEYS = Collections.unmodifiableList(list);</span>
<span class="fc" id="L105">  }</span>

  private final String timeZone;
  private final String delimiter;
  private final String scriptCharset;
  private final boolean fullLineDelimiter;
  private final boolean sendFullScript;
  private final boolean autoCommit;
  private final boolean removeCrs;
  private final boolean ignoreWarnings;
  private final String driverPath;
  private final String driver;
  private final String url;
  private final String username;
  private final String password;

  private final String hookBeforeUp;
  private final String hookBeforeEachUp;
  private final String hookAfterEachUp;
  private final String hookAfterUp;
  private final String hookBeforeDown;
  private final String hookBeforeEachDown;
  private final String hookAfterEachDown;
  private final String hookAfterDown;

  private final String hookBeforeNew;
  private final String hookAfterNew;

  private final String hookBeforeScript;
  private final String hookBeforeEachScript;
  private final String hookAfterEachScript;
  private final String hookAfterScript;

  /**
   * Prefix used to lookup environment variable or system property.
   */
  private static final String PREFIX = &quot;MIGRATIONS_&quot;;
<span class="fc" id="L142">  private final Map&lt;String, String&gt; envVars = System.getenv();</span>
<span class="fc" id="L143">  private final Properties sysProps = System.getProperties();</span>
<span class="fc" id="L144">  private final Properties variables = new Properties();</span>

<span class="fc" id="L146">  private final VariableReplacer parser = new VariableReplacer(Arrays.asList(sysProps, envVars));</span>

<span class="fc" id="L148">  public Environment(File file) {</span>
<span class="fc" id="L149">    Properties prop = mergeProperties(file);</span>

<span class="fc" id="L151">    this.timeZone = readProperty(prop, SETTING_KEY.TIME_ZONE.toString(), &quot;GMT+0:00&quot;);</span>
<span class="fc" id="L152">    this.delimiter = readProperty(prop, SETTING_KEY.DELIMITER.toString(), &quot;;&quot;);</span>
<span class="fc" id="L153">    this.scriptCharset = readProperty(prop, SETTING_KEY.SCRIPT_CHAR_SET.toString(),</span>
<span class="fc" id="L154">        Charset.defaultCharset().toString());</span>
<span class="fc" id="L155">    this.fullLineDelimiter = Boolean.parseBoolean(readProperty(prop, SETTING_KEY.FULL_LINE_DELIMITER.toString()));</span>
<span class="fc" id="L156">    this.sendFullScript = Boolean.parseBoolean(readProperty(prop, SETTING_KEY.SEND_FULL_SCRIPT.toString()));</span>
<span class="fc" id="L157">    this.autoCommit = Boolean.parseBoolean(readProperty(prop, SETTING_KEY.AUTO_COMMIT.toString()));</span>
<span class="fc" id="L158">    this.removeCrs = Boolean.parseBoolean(readProperty(prop, SETTING_KEY.REMOVE_CRS.toString()));</span>
<span class="fc" id="L159">    this.ignoreWarnings = Boolean.parseBoolean(readProperty(prop, SETTING_KEY.IGNORE_WARNINGS.toString(), &quot;true&quot;));</span>

<span class="fc" id="L161">    this.driverPath = readProperty(prop, SETTING_KEY.DRIVER_PATH.toString());</span>
<span class="fc" id="L162">    this.driver = readProperty(prop, SETTING_KEY.DRIVER.toString());</span>
<span class="fc" id="L163">    this.url = readProperty(prop, SETTING_KEY.URL.toString());</span>
<span class="fc" id="L164">    this.username = readProperty(prop, SETTING_KEY.USERNAME.toString());</span>
<span class="fc" id="L165">    this.password = readProperty(prop, SETTING_KEY.PASSWORD.toString());</span>

<span class="fc" id="L167">    this.hookBeforeUp = readProperty(prop, SETTING_KEY.HOOK_BEFORE_UP.toString());</span>
<span class="fc" id="L168">    this.hookBeforeEachUp = readProperty(prop, SETTING_KEY.HOOK_BEFORE_EACH_UP.toString());</span>
<span class="fc" id="L169">    this.hookAfterEachUp = readProperty(prop, SETTING_KEY.HOOK_AFTER_EACH_UP.toString());</span>
<span class="fc" id="L170">    this.hookAfterUp = readProperty(prop, SETTING_KEY.HOOK_AFTER_UP.toString());</span>
<span class="fc" id="L171">    this.hookBeforeDown = readProperty(prop, SETTING_KEY.HOOK_BEFORE_DOWN.toString());</span>
<span class="fc" id="L172">    this.hookBeforeEachDown = readProperty(prop, SETTING_KEY.HOOK_BEFORE_EACH_DOWN.toString());</span>
<span class="fc" id="L173">    this.hookAfterEachDown = readProperty(prop, SETTING_KEY.HOOK_AFTER_EACH_DOWN.toString());</span>
<span class="fc" id="L174">    this.hookAfterDown = readProperty(prop, SETTING_KEY.HOOK_AFTER_DOWN.toString());</span>

<span class="fc" id="L176">    this.hookBeforeNew = readProperty(prop, SETTING_KEY.HOOK_BEFORE_NEW.toString());</span>
<span class="fc" id="L177">    this.hookAfterNew = readProperty(prop, SETTING_KEY.HOOK_AFTER_NEW.toString());</span>

<span class="fc" id="L179">    this.hookBeforeScript = readProperty(prop, SETTING_KEY.HOOK_BEFORE_SCRIPT.toString());</span>
<span class="fc" id="L180">    this.hookBeforeEachScript = readProperty(prop, SETTING_KEY.HOOK_BEFORE_EACH_SCRIPT.toString());</span>
<span class="fc" id="L181">    this.hookAfterEachScript = readProperty(prop, SETTING_KEY.HOOK_AFTER_EACH_SCRIPT.toString());</span>
<span class="fc" id="L182">    this.hookAfterScript = readProperty(prop, SETTING_KEY.HOOK_AFTER_SCRIPT.toString());</span>

    // User defined variables.
<span class="fc bfc" id="L185" title="All 2 branches covered.">    prop.entrySet().stream().filter(e -&gt; !SETTING_KEYS.contains(e.getKey()))</span>
<span class="fc" id="L186">        .forEach(e -&gt; variables.put(e.getKey(), parser.replace((String) e.getValue())));</span>
<span class="fc" id="L187">  }</span>

  private Properties mergeProperties(File file) {
    // 1. Load from file.
<span class="fc" id="L191">    Properties prop = loadPropertiesFromFile(file);</span>
    // 2. Read environment variables (existing entries are overwritten).
<span class="fc" id="L193">    envVars.entrySet().stream().filter(e -&gt; isMigrationsKey(e.getKey()))</span>
<span class="fc" id="L194">        .forEach(e -&gt; prop.put(normalizeKey(e.getKey()), e.getValue()));</span>
    // 3. Read system properties (existing entries are overwritten).
<span class="fc" id="L196">    sysProps.entrySet().stream().filter(e -&gt; isMigrationsKey((String) e.getKey()))</span>
<span class="fc" id="L197">        .forEach(e -&gt; prop.put(normalizeKey((String) e.getKey()), e.getValue()));</span>
<span class="fc" id="L198">    return prop;</span>
  }

  private String normalizeKey(String key) {
<span class="fc" id="L202">    return key.substring(PREFIX.length()).toLowerCase(Locale.ENGLISH);</span>
  }

  private boolean isMigrationsKey(String key) {
<span class="fc bfc" id="L206" title="All 4 branches covered.">    return key.length() &gt; PREFIX.length() &amp;&amp; key.toUpperCase(Locale.ENGLISH).startsWith(PREFIX);</span>
  }

  private Properties loadPropertiesFromFile(File file) {
<span class="fc" id="L210">    Properties properties = new Properties();</span>
<span class="fc" id="L211">    try (FileInputStream inputStream = new FileInputStream(file)) {</span>
<span class="fc" id="L212">      properties.load(inputStream);</span>
<span class="fc" id="L213">      return properties;</span>
<span class="nc" id="L214">    } catch (FileNotFoundException e) {</span>
<span class="nc" id="L215">      throw new MigrationException(&quot;Environment file missing: &quot; + file.getAbsolutePath());</span>
<span class="nc" id="L216">    } catch (IOException e) {</span>
<span class="nc" id="L217">      throw new MigrationException(&quot;Error loading environment properties.  Cause: &quot; + e, e);</span>
    }
  }

  private String readProperty(Properties properties, String propertyKey) {
<span class="fc" id="L222">    return readProperty(properties, propertyKey, null);</span>
  }

  private String readProperty(Properties properties, String propertyKey, String defaultValue) {
<span class="fc" id="L226">    String property = properties.getProperty(propertyKey, defaultValue);</span>
<span class="fc bfc" id="L227" title="All 2 branches covered.">    return property == null ? null : parser.replace(property);</span>
  }

  public String getTimeZone() {
<span class="fc" id="L231">    return timeZone;</span>
  }

  public String getDelimiter() {
<span class="fc" id="L235">    return delimiter;</span>
  }

  public String getScriptCharset() {
<span class="fc" id="L239">    return scriptCharset;</span>
  }

  public boolean isFullLineDelimiter() {
<span class="fc" id="L243">    return fullLineDelimiter;</span>
  }

  public boolean isSendFullScript() {
<span class="fc" id="L247">    return sendFullScript;</span>
  }

  public boolean isAutoCommit() {
<span class="fc" id="L251">    return autoCommit;</span>
  }

  public boolean isRemoveCrs() {
<span class="fc" id="L255">    return removeCrs;</span>
  }

  public boolean isIgnoreWarnings() {
<span class="fc" id="L259">    return ignoreWarnings;</span>
  }

  public String getDriverPath() {
<span class="fc" id="L263">    return driverPath;</span>
  }

  public String getDriver() {
<span class="fc" id="L267">    return driver;</span>
  }

  public String getUrl() {
<span class="fc" id="L271">    return url;</span>
  }

  public String getUsername() {
<span class="fc" id="L275">    return username;</span>
  }

  public String getPassword() {
<span class="fc" id="L279">    return password;</span>
  }

  public String getHookBeforeUp() {
<span class="fc" id="L283">    return hookBeforeUp;</span>
  }

  public String getHookBeforeEachUp() {
<span class="fc" id="L287">    return hookBeforeEachUp;</span>
  }

  public String getHookAfterEachUp() {
<span class="fc" id="L291">    return hookAfterEachUp;</span>
  }

  public String getHookAfterUp() {
<span class="fc" id="L295">    return hookAfterUp;</span>
  }

  public String getHookBeforeDown() {
<span class="fc" id="L299">    return hookBeforeDown;</span>
  }

  public String getHookBeforeEachDown() {
<span class="fc" id="L303">    return hookBeforeEachDown;</span>
  }

  public String getHookAfterEachDown() {
<span class="fc" id="L307">    return hookAfterEachDown;</span>
  }

  public String getHookAfterDown() {
<span class="fc" id="L311">    return hookAfterDown;</span>
  }

  public String getHookBeforeNew() {
<span class="fc" id="L315">    return hookBeforeNew;</span>
  }

  public String getHookAfterNew() {
<span class="fc" id="L319">    return hookAfterNew;</span>
  }

  public String getHookBeforeScript() {
<span class="fc" id="L323">    return hookBeforeScript;</span>
  }

  public String getHookBeforeEachScript() {
<span class="fc" id="L327">    return hookBeforeEachScript;</span>
  }

  public String getHookAfterEachScript() {
<span class="fc" id="L331">    return hookAfterEachScript;</span>
  }

  public String getHookAfterScript() {
<span class="fc" id="L335">    return hookAfterScript;</span>
  }

  public Properties getVariables() {
<span class="fc" id="L339">    return variables;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>