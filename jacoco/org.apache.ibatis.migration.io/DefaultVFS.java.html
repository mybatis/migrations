<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DefaultVFS.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MyBatis Migrations</a> &gt; <a href="index.source.html" class="el_package">org.apache.ibatis.migration.io</a> &gt; <span class="el_source">DefaultVFS.java</span></div><h1>DefaultVFS.java</h1><pre class="source lang-java linenums">/*
 *    Copyright 2010-2025 the original author or authors.
 *
 *    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 *    you may not use this file except in compliance with the License.
 *    You may obtain a copy of the License at
 *
 *       https://www.apache.org/licenses/LICENSE-2.0
 *
 *    Unless required by applicable law or agreed to in writing, software
 *    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *    See the License for the specific language governing permissions and
 *    limitations under the License.
 */
package org.apache.ibatis.migration.io;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.net.MalformedURLException;
import java.net.URL;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.nio.file.InvalidPathException;
import java.nio.file.Path;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.jar.JarEntry;
import java.util.jar.JarInputStream;
import java.util.logging.Level;
import java.util.logging.Logger;

/**
 * A default implementation of {@link VFS} that works for most application servers.
 *
 * @author Ben Gunter
 */
<span class="fc" id="L43">public class DefaultVFS extends VFS {</span>
<span class="fc" id="L44">  private static final Logger log = Logger.getLogger(DefaultVFS.class.getName());</span>

  /** The magic header that indicates a JAR (ZIP) file. */
<span class="fc" id="L47">  private static final byte[] JAR_MAGIC = { 'P', 'K', 3, 4 };</span>

  @Override
  public boolean isValid() {
<span class="fc" id="L51">    return true;</span>
  }

  @Override
  public List&lt;String&gt; list(URL url, String path) throws IOException {
<span class="fc" id="L56">    InputStream is = null;</span>
    try {
<span class="fc" id="L58">      List&lt;String&gt; resources = new ArrayList&lt;&gt;();</span>

      // First, try to find the URL of a JAR file containing the requested resource. If a JAR
      // file is found, then we'll list child resources by reading the JAR.
<span class="fc" id="L62">      URL jarUrl = findJarForResource(url);</span>
<span class="pc bpc" id="L63" title="1 of 2 branches missed.">      if (jarUrl != null) {</span>
<span class="nc" id="L64">        is = jarUrl.openStream();</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">        if (log.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L66">          log.log(Level.FINER, &quot;Listing &quot; + url);</span>
        }
<span class="nc" id="L68">        resources = listResources(new JarInputStream(is), path);</span>
      } else {
<span class="fc" id="L70">        List&lt;String&gt; children = new ArrayList&lt;&gt;();</span>
        try {
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">          if (isJar(url)) {</span>
            // Some versions of JBoss VFS might give a JAR stream even if the resource
            // referenced by the URL isn't actually a JAR
<span class="nc" id="L75">            is = url.openStream();</span>
<span class="nc" id="L76">            try (JarInputStream jarInput = new JarInputStream(is)) {</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">              if (log.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L78">                log.log(Level.FINER, &quot;Listing &quot; + url);</span>
              }
<span class="nc bnc" id="L80" title="All 2 branches missed.">              for (JarEntry entry; (entry = jarInput.getNextJarEntry()) != null;) {</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">                if (log.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L82">                  log.log(Level.FINER, &quot;Jar entry: &quot; + entry.getName());</span>
                }
<span class="nc" id="L84">                children.add(entry.getName());</span>
              }
            }
          } else {
            /*
             * Some servlet containers allow reading from directory resources like a text file, listing the child
             * resources one per line. However, there is no way to differentiate between directory and file resources
             * just by reading them. To work around that, as each line is read, try to look it up via the class loader
             * as a child of the current resource. If any line fails then we assume the current resource is not a
             * directory.
             */
<span class="fc" id="L95">            is = url.openStream();</span>
<span class="fc" id="L96">            List&lt;String&gt; lines = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L97">            try (BufferedReader reader = new BufferedReader(new InputStreamReader(is))) {</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">              for (String line; (line = reader.readLine()) != null;) {</span>
<span class="pc bpc" id="L99" title="1 of 2 branches missed.">                if (log.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L100">                  log.log(Level.FINER, &quot;Reader entry: &quot; + line);</span>
                }
<span class="fc" id="L102">                lines.add(line);</span>
<span class="fc bfc" id="L103" title="All 2 branches covered.">                if (getResources(path + &quot;/&quot; + line).isEmpty()) {</span>
<span class="fc" id="L104">                  lines.clear();</span>
<span class="fc" id="L105">                  break;</span>
                }
              }
<span class="nc" id="L108">            } catch (InvalidPathException e) {</span>
              // #1974
<span class="nc" id="L110">              lines.clear();</span>
<span class="fc" id="L111">            }</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">            if (!lines.isEmpty()) {</span>
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">              if (log.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L114">                log.log(Level.FINER, &quot;Listing &quot; + url);</span>
              }
<span class="fc" id="L116">              children.addAll(lines);</span>
            }
          }
<span class="nc" id="L119">        } catch (FileNotFoundException e) {</span>
          /*
           * For file URLs the openStream() call might fail, depending on the servlet container, because directories
           * can't be opened for reading. If that happens, then list the directory directly instead.
           */
<span class="nc bnc" id="L124" title="All 2 branches missed.">          if (!&quot;file&quot;.equals(url.getProtocol())) {</span>
            // No idea where the exception came from so rethrow it
<span class="nc" id="L126">            throw e;</span>
          }
<span class="nc" id="L128">          File file = Path.of(url.getFile()).toFile();</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">          if (log.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L130">            log.log(Level.FINER, &quot;Listing directory &quot; + file.getAbsolutePath());</span>
          }
<span class="nc bnc" id="L132" title="All 2 branches missed.">          if (file.isDirectory()) {</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">            if (log.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L134">              log.log(Level.FINER, &quot;Listing &quot; + url);</span>
            }
<span class="nc" id="L136">            children = Arrays.asList(file.list());</span>
          }
<span class="fc" id="L138">        }</span>

        // The URL prefix to use when recursively listing child resources
<span class="fc" id="L141">        String prefix = url.toExternalForm();</span>
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">        if (!prefix.endsWith(&quot;/&quot;)) {</span>
<span class="fc" id="L143">          prefix = prefix + &quot;/&quot;;</span>
        }

        // Iterate over immediate children, adding files and recurring into directories
<span class="fc bfc" id="L147" title="All 2 branches covered.">        for (String child : children) {</span>
<span class="fc" id="L148">          String resourcePath = path + &quot;/&quot; + child;</span>
<span class="fc" id="L149">          resources.add(resourcePath);</span>
<span class="fc" id="L150">          URL childUrl = new URL(prefix + child);</span>
<span class="fc" id="L151">          resources.addAll(list(childUrl, resourcePath));</span>
<span class="fc" id="L152">        }</span>
      }

<span class="fc" id="L155">      return resources;</span>
    } finally {
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">      if (is != null) {</span>
        try {
<span class="fc" id="L159">          is.close();</span>
<span class="nc" id="L160">        } catch (Exception e) {</span>
          // Ignore
<span class="fc" id="L162">        }</span>
      }
    }
  }

  /**
   * List the names of the entries in the given {@link JarInputStream} that begin with the specified {@code path}.
   * Entries will match with or without a leading slash.
   *
   * @param jar
   *          The JAR input stream
   * @param path
   *          The leading path to match
   *
   * @return The names of all the matching entries
   *
   * @throws IOException
   *           If I/O errors occur
   */
  protected List&lt;String&gt; listResources(JarInputStream jar, String path) throws IOException {
    // Include the leading and trailing slash when matching names
<span class="nc bnc" id="L183" title="All 2 branches missed.">    if (!path.startsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L184">      path = '/' + path;</span>
    }
<span class="nc bnc" id="L186" title="All 2 branches missed.">    if (!path.endsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L187">      path = path + '/';</span>
    }

    // Iterate over the entries and collect those that begin with the requested path
<span class="nc" id="L191">    List&lt;String&gt; resources = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">    for (JarEntry entry; (entry = jar.getNextJarEntry()) != null;) {</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">      if (!entry.isDirectory()) {</span>
        // Add leading slash if it's missing
<span class="nc" id="L195">        StringBuilder name = new StringBuilder(entry.getName());</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">        if (name.charAt(0) != '/') {</span>
<span class="nc" id="L197">          name.insert(0, '/');</span>
        }

        // Check file name
<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (name.indexOf(path) == 0) {</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">          if (log.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L203">            log.log(Level.FINER, &quot;Found resource: &quot; + name);</span>
          }
          // Trim leading slash
<span class="nc" id="L206">          resources.add(name.substring(1));</span>
        }
<span class="nc" id="L208">      }</span>
    }
<span class="nc" id="L210">    return resources;</span>
  }

  /**
   * Attempts to deconstruct the given URL to find a JAR file containing the resource referenced by the URL. That is,
   * assuming the URL references a JAR entry, this method will return a URL that references the JAR file containing the
   * entry. If the JAR cannot be located, then this method returns null.
   *
   * @param url
   *          The URL of the JAR entry.
   *
   * @return The URL of the JAR file, if one is found. Null if not.
   *
   * @throws MalformedURLException
   *           the malformed URL exception
   */
  protected URL findJarForResource(URL url) throws MalformedURLException {
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">    if (log.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L228">      log.log(Level.FINER, &quot;Find JAR URL: &quot; + url);</span>
    }

    // If the file part of the URL is itself a URL, then that URL probably points to the JAR
<span class="fc" id="L232">    boolean continueLoop = true;</span>
<span class="fc bfc" id="L233" title="All 2 branches covered.">    while (continueLoop) {</span>
      try {
<span class="nc" id="L235">        url = new URL(url.getFile());</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">        if (log.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L237">          log.log(Level.FINER, &quot;Inner URL: &quot; + url);</span>
        }
<span class="fc" id="L239">      } catch (MalformedURLException e) {</span>
        // This will happen at some point and serves as a break in the loop
<span class="fc" id="L241">        continueLoop = false;</span>
<span class="pc" id="L242">      }</span>
    }

    // Look for the .jar extension and chop off everything after that
<span class="fc" id="L246">    StringBuilder jarUrl = new StringBuilder(url.toExternalForm());</span>
<span class="fc" id="L247">    int index = jarUrl.lastIndexOf(&quot;.jar&quot;);</span>
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">    if (index &lt; 0) {</span>
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">      if (log.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L250">        log.log(Level.FINER, &quot;Not a JAR: &quot; + jarUrl);</span>
      }
<span class="fc" id="L252">      return null;</span>
    }
<span class="nc" id="L254">    jarUrl.setLength(index + 4);</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">    if (log.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L256">      log.log(Level.FINER, &quot;Extracted JAR URL: &quot; + jarUrl);</span>
    }

    // Try to open and test it
    try {
<span class="nc" id="L261">      URL testUrl = new URL(jarUrl.toString());</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">      if (isJar(testUrl)) {</span>
<span class="nc" id="L263">        return testUrl;</span>
      }
      // WebLogic fix: check if the URL's file exists in the filesystem.
<span class="nc bnc" id="L266" title="All 2 branches missed.">      if (log.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L267">        log.log(Level.FINER, &quot;Not a JAR: &quot; + jarUrl);</span>
      }
<span class="nc" id="L269">      jarUrl.replace(0, jarUrl.length(), testUrl.getFile());</span>
<span class="nc" id="L270">      File file = Path.of(jarUrl.toString()).toFile();</span>

      // File name might be URL-encoded
<span class="nc bnc" id="L273" title="All 2 branches missed.">      if (!file.exists()) {</span>
<span class="nc" id="L274">        file = Path.of(URLEncoder.encode(jarUrl.toString(), StandardCharsets.UTF_8)).toFile();</span>
      }

<span class="nc bnc" id="L277" title="All 2 branches missed.">      if (file.exists()) {</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">        if (log.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L279">          log.log(Level.FINER, &quot;Trying real file: &quot; + file.getAbsolutePath());</span>
        }
<span class="nc" id="L281">        testUrl = file.toURI().toURL();</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">        if (isJar(testUrl)) {</span>
<span class="nc" id="L283">          return testUrl;</span>
        }
      }
<span class="nc" id="L286">    } catch (MalformedURLException e) {</span>
<span class="nc" id="L287">      log.log(Level.WARNING, &quot;Invalid JAR URL: &quot; + jarUrl);</span>
<span class="nc" id="L288">    }</span>

<span class="nc bnc" id="L290" title="All 2 branches missed.">    if (log.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L291">      log.log(Level.FINER, &quot;Not a JAR: &quot; + jarUrl);</span>
    }
<span class="nc" id="L293">    return null;</span>
  }

  /**
   * Converts a Java package name to a path that can be looked up with a call to
   * {@link ClassLoader#getResources(String)}.
   *
   * @param packageName
   *          The Java package name to convert to a path
   *
   * @return the package path
   */
  protected String getPackagePath(String packageName) {
<span class="nc bnc" id="L306" title="All 2 branches missed.">    return packageName == null ? null : packageName.replace('.', '/');</span>
  }

  /**
   * Returns true if the resource located at the given URL is a JAR file.
   *
   * @param url
   *          The URL of the resource to test.
   *
   * @return true, if is jar
   */
  protected boolean isJar(URL url) {
<span class="fc" id="L318">    return isJar(url, new byte[JAR_MAGIC.length]);</span>
  }

  /**
   * Returns true if the resource located at the given URL is a JAR file.
   *
   * @param url
   *          The URL of the resource to test.
   * @param buffer
   *          A buffer into which the first few bytes of the resource are read. The buffer must be at least the size of
   *          {@link #JAR_MAGIC}. (The same buffer may be reused for multiple calls as an optimization.)
   *
   * @return true, if is jar
   */
  protected boolean isJar(URL url, byte[] buffer) {
<span class="fc" id="L333">    try (InputStream is = url.openStream()) {</span>
<span class="fc" id="L334">      is.read(buffer, 0, JAR_MAGIC.length);</span>
<span class="pc bpc" id="L335" title="1 of 2 branches missed.">      if (Arrays.equals(buffer, JAR_MAGIC)) {</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">        if (log.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L337">          log.log(Level.FINER, &quot;Found JAR: &quot; + url);</span>
        }
<span class="nc" id="L339">        return true;</span>
      }
<span class="nc bnc" id="L341" title="All 2 branches missed.">    } catch (Exception e) {</span>
      // Failure to read the stream means this is not a JAR
<span class="fc" id="L343">    }</span>

<span class="fc" id="L345">    return false;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>